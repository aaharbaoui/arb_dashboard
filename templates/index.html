<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Arb Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
  <script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          primary: {
            "50": "#eff6ff", "100": "#dbeafe", "200": "#bfdbfe", "300": "#93c5fd",
            "400": "#60a5fa", "500": "#3b82f6", "600": "#2563eb", "700": "#1d4ed8",
            "800": "#1e40af", "900": "#1e3a8a", "950": "#172554"
          }
        }
      },
      fontFamily: {
        body: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif'],
        sans: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif']
      }
    }
  }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <main class="max-w-screen-xl mx-auto px-4 py-8 font-sans text-white space-y-10">
    <h1 class="text-4xl font-bold text-primary-400 text-center mb-6">AMINE'S DASHBOARD</h1>

    <section>
      <h2 class="text-2xl font-semibold text-primary-300 text-center mb-4">TOP 5 HIGH SPREAD TOKENS</h2>
      {% include "top5_table.html" %}
    </section>

    <section>
      <h2 class="text-2xl font-semibold text-primary-300 text-center mb-4">CALCULATOR</h2>
      {% include "calculator.html" %}
    </section>

    <section>
      <h2 class="text-2xl font-semibold text-primary-300 text-center mb-4">EXCHANGES TOGGLES</h2>
      <div id="toggles" class="flex gap-4 flex-wrap justify-center"></div>
    </section>

    <section>
      <h2 class="text-2xl font-semibold text-primary-300 text-center mb-4">LIVE TOKEN PRICES</h2>
      <div class="tbl-content">
        <table>
          <thead id="prices-head"></thead>
          <tbody id="prices-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const EX = {{ exchanges | tojson }};
    let state = {{ enabled | tojson }};

    function buildToggles() {
      return EX.map(e => `
        <label>
          ${e}
          <button class="toggle ${state[e] ? 'on' : ''}" data-ex="${e}">
            <span class="slider"></span>
          </button>
        </label>
      `).join('');
    }

    function updateToggles() {
      document.getElementById("toggles").innerHTML = buildToggles();
      document.querySelectorAll(".toggle").forEach(btn => {
        btn.addEventListener("click", e => {
          const ex = btn.dataset.ex;
          state[ex] = !state[ex];
          btn.classList.toggle("on", state[ex]);
          loadData();
        });
      });
    }

    async function loadData() {
      const resTop = await fetch("/api/top5", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(state)
      });
      const top5 = await resTop.json();

      const resAll = await fetch("/api/allprices", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(state)
      });
      const all = await resAll.json();

      document.getElementById("top5-body").innerHTML = top5.length
        ? top5.map(t => `
          <tr class="highlight">
            <td class="text">${t.star ? '⭐️ ' : ''}${t.token}</td>
            <td class="numeric">${t.spread}%</td>
            <td class="text">${t.buy_ex}</td>
            <td class="text">${t.sell_ex}</td>
            <td class="text">${t.network}</td>
            <td class="numeric">${t.withdrawal}</td>
            <td class="numeric">${t.fees}</td>
          </tr>
        `).join('')
        : `<tr><td colspan="7" class="text-center">No high-spread tokens found</td></tr>`;

      let headRow = `<th>Token</th>`;
      EX.filter(e => state[e]).forEach(e => {
        headRow += `<th colspan="2">${e}</th>`;
      });
      document.getElementById("prices-head").innerHTML = `<tr>${headRow}</tr>`;

      let rows = all.slice(0, 30).map(row => {
        let cells = `<td class="text">${row.token}</td>`;
        EX.filter(e => state[e]).forEach(() => {
          const buy = typeof row.buy === "number" ? row.buy.toFixed(6) : "–";
          const sell = typeof row.sell === "number" ? row.sell.toFixed(6) : "–";
          cells += `<td class="buy numeric">${buy}</td><td class="sell numeric">${sell}</td>`;
        });
        return `<tr>${cells}</tr>`;
      }).join('');
      document.getElementById("prices-body").innerHTML = rows;

      buildCalculator(top5[0]);
    }

    function buildCalculator(top) {
      const tokenList = {{ tokens | tojson }};
      const calcBtn = document.getElementById("calcBtn");
      if (!calcBtn) return;

      calcBtn.addEventListener("click", () => {
        const inputToken = document.getElementById("tokenInput").value.trim();
        const inputAmount = parseFloat(document.getElementById("amount").value);
        const resultBox = document.getElementById("calcResult");

        if (!tokenList.includes(inputToken)) {
          resultBox.innerText = "❌ Invalid token";
          return;
        }

        const spread = top && top.token === inputToken ? top.spread : null;

        if (!spread) {
          resultBox.innerText = "❌ No spread data";
          return;
        }

        if (isNaN(inputAmount) || inputAmount <= 0) {
          resultBox.innerText = "❌ Invalid amount";
          return;
        }

        const profit = inputAmount * spread / 100;
        resultBox.innerText = `≈ $${profit.toFixed(2)}`;
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      updateToggles();
      loadData();
    });
  </script>
</body>
</html>
